#TouhouDanmakufu[Single]
#System["C:/Users/Matt/Documents/th_dnh_ph3/script/firstBoss/system/New_System.txt"]
#Background["script/firstBoss/system/Default_Background_IceMountain.txt"]
#ScriptVersion[3]
#Title["spell2"]
#Text["spell2"]
#BGM["./necrofantasia.ogg"]
#include "script/default_system/Default_ShotConst.txt"
#include "script/Stellar FX/Stellar.dnh"
let objBoss;
let objScene=GetEnemyBossSceneObjectID();
let imgBoss = GetCurrentScriptDirectory ~ "./dot_komachi.png";
let objBossState=0;
let pos = ObjPrim_Create(OBJ_SPRITE_2D());
let left;
let right;
let time;
let count=0;
@Event{
    alternative(GetEventType())
    case(EV_REQUEST_LIFE){
        SetScriptResult(3000);
    }
    case(EV_REQUEST_TIMER){
        SetScriptResult(60);
    }
    case(EV_REQUEST_SPELL_SCORE){
        SetScriptResult(1000000);
    }
}
@Initialize{
    objBoss = ObjEnemy_Create(OBJ_ENEMY_BOSS);
    ObjEnemy_Regist(objBoss);
    ObjMove_SetDestAtFrame(objBoss, GetCenterX, 60, 60);
    ObjEnemyBossScene_StartSpell(objScene);
    TDrawLoop;
    TFinalize;
    MainTask;
}
@MainLoop{
    ObjEnemy_SetIntersectionCircleToShot(objBoss, ObjMove_GetX(objBoss), ObjMove_GetY(objBoss), 32); 
    ObjEnemy_SetIntersectionCircleToPlayer(objBoss, ObjMove_GetX(objBoss), ObjMove_GetY(objBoss), 24);
    yield;
}
task MainTask{
	Stellar_Init();
    wait(120);
	
	//movement;
	let dir=1;
	loop{
		Stellar_Charge(objBoss,20,0.2,BLEND_ALPHA,360);
		wait(20);
		sycthe(dir);
		wait(10);
		movement;
		wait(730);
		dir=dir*-1;
	}
	  //spirit;
	  //coin;
	  //coinburst;
	  //scytheSt;
   // movement;
 
}
task sycthe(dir){
	let x;
	let y;
	let obj = CreateShotA1(ObjMove_GetX(objBoss),ObjMove_GetY(objBoss),0,0,DS_SCALE_A_WHITE,10);
	
	x=GetPlayerX();
	y=GetScreenHeight();
	CreateStraightLaserA1(x,y,(360-360/4),GetScreenHeight()+20,60,550,DS_BEAM_PURPLE,80);
	ObjMove_SetDestAtFrame(obj,x,y,80);
	wait(50);
	spread(x,y);
	wait(30);
	//spirit(x,y);
	spiritb(x,y,dir);
	wait(10);
	//wait(500);
	release(x,y);
	//CreateShotA1(x,y,1,180+45,DS_SCALE_A_WHITE,0);
	
}
task spread(x,y){
	let hold=0;
	loop(2){
		ascent(n in 0..2){	
			hold=(180/(15+n));
			ascent(i in 0..180/hold){
				CreateShotA1(x,y,1.2,180+i*hold,DS_BALL_SS_WHITE,5+n*4);
			}
			hold=(180/(18+n));
			ascent(i in 0..180/hold){
				CreateShotA1(x,y,1.1,180+i*hold,DS_BALL_SS_WHITE,10+n*4);
			}
		}
	}
}
task release(x,y){
	//DS_BALL_SS_PURPLE 460
	loop(3){
		ascent(i in 0..50){
			clumpl(x,y,i);
			clumpr(x,y,i);
			wait(2);
		}
		wait(5);
	}
	/*loop(6){
		ascent(i in 0..GetStgFrameHeight/60){
			CreateShotA1(0,i*60,1,0,DS_BALL_SS_PURPLE,15);
			CreateShotA1(GetStgFrameWidth,i*60,1,180,DS_BALL_SS_PURPLE,15);
		}wait(70);}*/
}
task clumpl(x,y,i){
	let obj=CreateShotA1(0,cos(i*35)*(GetStgFrameHeight/2)+(GetStgFrameHeight/2),1.5,0,DS_BALL_BS_PURPLE,15);
	ObjRender_SetBlendType(obj, BLEND_ALPHA);
	ObjMove_SetDestAtSpeed(obj,GetStgFrameWidth,cos(i*35+25)*(GetStgFrameHeight/2)+(GetStgFrameHeight/2),1.5);
	while(ObjMove_GetX(obj)<x){yield;}
	Obj_Delete(obj);
}
task clumpr(x,y,i){
	let obj=CreateShotA1(GetStgFrameWidth,-cos(i*35)*(GetStgFrameHeight/2)+(GetStgFrameHeight/2),1.5,0,DS_BALL_BS_PURPLE,15);
	ObjRender_SetBlendType(obj, BLEND_ALPHA);
	ObjMove_SetDestAtSpeed(obj,0,-cos(i*35+25)*(GetStgFrameHeight/2)+(GetStgFrameHeight/2),1.5);
	while(ObjMove_GetX(obj)>x){yield;}
	Obj_Delete(obj);
}
task spiritb(x,y,dir){
	//750
	time=0;
	ascent(i in 0..100){
		 //CreateShotA2(x,GetScreenHeight,0,0,0,1,DS_BALL_S_PURPLE,10);
		//let obj= CreateShotA1(x+5,GetStgFrameHeight,2,270+45+cos(i*17)*45/2,DS_BALL_S_PURPLE,10);
		let obj= CreateShotA1(x+5*dir,GetStgFrameHeight,2,270+50+cos(i*17)*30*dir,DS_BALL_S_PURPLE,10);
		//ObjMove_AddPatternB2(obj,0,2,NO_CHANGE,-0.015,0,-2,2);
		ObjMove_AddPatternB2(obj,0,2*dir,NO_CHANGE,-0.025*dir+cos(i*8)*0.015,0,-2*dir,2);
		//ObjMove_AddPatternB2(obj,0,2,NO_CHANGE,-0.04,0,-2,2);
		//ObjMove_AddPatternB1(obj,100+cos(i*20)*50,-2,NO_CHANGE);
		
		let left= CreateShotA1(x-5*dir,GetStgFrameHeight,2,270-50+cos(i*17)*30*dir,DS_BALL_S_PURPLE,10);
		ObjMove_AddPatternB2(left,0,-2*dir,NO_CHANGE,0.025*dir+cos(i*8)*0.015,0,2*dir,2);
		//ObjMove_AddPatternB1(left,100+cos(i*20)*50,2,NO_CHANGE);
			//wait(5);
		red(x,y,1*dir,i+1);
		redl(x,y,-1*dir,i+1);
		wait(5);
		time=time+5;
		//i=i+1;
	}
	
}
task red(x,y,dir,i){
	let obj= CreateShotA1(x+10*dir,GetStgFrameHeight,2,270+(50+cos(i*17)*30*dir),DS_BALL_S_BLUE,10);
		//ObjMove_AddPatternB2(obj,0,2,NO_CHANGE,-0.015,0,-2,2);
		ObjMove_AddPatternB2(obj,0,2*dir,NO_CHANGE,(-0.025*dir)+cos(i*8)*0.015,0,-2*dir,2);
		if(dir>0){
			while(ObjMove_GetX(obj)>x){yield;}
		}else{
			while(ObjMove_GetX(obj)<x){yield;}
		}
	ObjShot_SetDelay(obj,500+rand(3,20)-time);
	}
task redl(x,y,dir,i){
	let obj= CreateShotA1(x+10*dir,GetStgFrameHeight,2,270+(50+cos(i*17)*30*dir),DS_BALL_S_BLUE,10);
		//ObjMove_AddPatternB2(obj,0,2,NO_CHANGE,-0.015,0,-2,2);
		ObjMove_AddPatternB2(obj,0,2*dir,NO_CHANGE,(-0.025*dir)+cos(i*8)*0.015,0,-2*dir,2);
	//while(ObjMove_GetX(obj)<x){yield;}
	if(dir>0){
			while(ObjMove_GetX(obj)>x){yield;}
		}else{
			while(ObjMove_GetX(obj)<x){yield;}
		}
	
	ObjShot_SetDelay(obj,520+rand(3,20)-time);
}

task shoot(time,obj,dir){
	let hold = GetStgFrameWidth()/2;
		wait(500-time-10);
		ObjShot_SetDelay(obj,10);
		wait(10);
		//ObjMove_SetDestAtFrame(left,x,ObjMove_GetY(left),40);
		ObjMove_SetDestAtFrame(obj,hold+hold*dir,rand(ObjMove_GetY(obj)-5,ObjMove_GetY(obj)+5),60);
		ObjShot_SetDeleteFrame(obj,65);
		//wait(40);
		//ObjMove_SetSpeed(obj,2);
}


task movement{
	//let count=0; 730
    while(ObjEnemy_GetInfo(objBoss, INFO_LIFE) > 0){
		
       /* let x=rand(GetCenterX + 90, GetCenterX - 90);
		let y= rand(GetCenterY - 60, GetCenterY - 120);
		let hold=ObjPrim_Create(OBJ_SPRITE_2D());
		ObjRender_SetX(hold,x);
        ObjRender_SetY(hold,y);
		
        wait(240);*/
		wait(100);
		loop(50){
			let hold=ObjPrim_Create(OBJ_SPRITE_2D());
			let x=cos(count)*100+192;
			let y=sin(count)*30+90;
			ObjRender_SetX(hold,x);
			ObjRender_SetY(hold,y);
			ObjMove_SetDestAtFrame(objBoss,x,y,GetObjectDistance(objBoss,hold)/2);
			count=count+20;
			//wait(GetObjectDistance(objBoss,hold)/2);
			wait(12)
			//yield;
		}
    }
}
task TDrawLoop {
   		//125 width	256 height
	let animFrame = 0;
	let animFrame2 = 0;
	let dir;
	let speed; 
		// texture the boss, set centre as true centre.
	ObjPrim_SetTexture(objBoss,imgBoss);
	ObjSprite2D_SetSourceRect(objBoss,0,0,128,128);
	ObjSprite2D_SetDestCenter(objBoss);
		//ObjRender_SetScaleXYZ(objBoss,1.0,1.0,0);
	
	while(!Obj_IsDeleted(objBoss)) {
	
		// update boss speed/dir locally
		dir = ObjMove_GetAngle(objBoss);
		speed = ObjMove_GetSpeed(objBoss);
		
		// animation handling
		//alternative(objBossState)
		if(speed == 0){ 
		//alternative(objBossState)
		//case(0){
			ObjRender_SetAngleXYZ(objBoss,0,0,0);
			ObjSprite2D_SetSourceRect(objBoss,0,0,128,128);
			if(animFrame < 15) { ObjSprite2D_SetSourceRect(objBoss,0,0,128,128);}
			if(animFrame >= 15 && animFrame < 30) { ObjSprite2D_SetSourceRect(objBoss,0,128,128,128*2);}
			if(animFrame >= 30 && animFrame < 45) { ObjSprite2D_SetSourceRect(objBoss,0,128*2,128,128*3);}
			//if(animFrame >= 45) { ObjSprite2D_SetSourceRect(objBoss,0,128*3,128,128*4); WriteLog(4);}
			animFrame2 = 0;
		//}
		}
		else if(cos(dir) < 0){ 
		//WriteLog(1);
			//ObjRender_SetAngleXYZ(objBoss,0,180,0);	// flip vertical
			if(animFrame2 < 15) { ObjSprite2D_SetSourceRect(objBoss,128*3,128*3,128*4,128*4); }
			if(animFrame2 >= 15 && animFrame2 <= 45) { ObjSprite2D_SetSourceRect(objBoss,128*3,128*4,128*4,128*5); }
			//if(animFrame2 >= 30 && animFrame2 < 45) { ObjSprite2D_SetSourceRect(objBoss,128,64,192,128); }
			//if(animFrame2 >= 45) { ObjSprite2D_SetSourceRect(objBoss,192,64,256,128); }
		}
		else if(cos(dir) > 0){ 
		//WriteLog(0);
			ObjRender_SetAngleXYZ(objBoss,0,180,0);	// flip vertical
			if(animFrame2 < 15) { ObjSprite2D_SetSourceRect(objBoss,128*3,128*3,128*4,128*4); }
			if(animFrame2 >= 15 && animFrame2 <= 45) { ObjSprite2D_SetSourceRect(objBoss,128*3,128*4,128*4,128*5); }
			//if(animFrame2 >= 30 && animFrame2 < 45) { ObjSprite2D_SetSourceRect(objBoss,128,128,192,192); }
			//if(animFrame2 >= 45) { ObjSprite2D_SetSourceRect(objBoss,192,128,256,192); }  
		}
		animFrame++;		// count animFrame. (++ is +1)
		animFrame2+=2;		// count animFrame2.
		if(animFrame > 60) { animFrame = 0; }	// reset animFrame when it is higher than 60.
		yield;
	}
}
task TFinalize {
    while(ObjEnemy_GetInfo(objBoss, INFO_LIFE) > 0){yield;}
    if(ObjEnemyBossScene_GetInfo(objScene, INFO_PLAYER_SHOOTDOWN_COUNT)
            +ObjEnemyBossScene_GetInfo(objScene, INFO_PLAYER_SPELL_COUNT) == 0){
        AddScore(ObjEnemyBossScene_GetInfo(objScene, INFO_SPELL_SCORE));
    }
    Obj_Delete(objBoss);
    DeleteShotAll(TYPE_ALL, TYPE_IMMEDIATE);
    SetAutoDeleteObject(true);
    CloseScript(GetOwnScriptID());
    return;
}
function GetCenterX(){
    return GetStgFrameWidth() / 2;
}
function GetCenterY(){
    return GetStgFrameHeight() / 2;
}
function wait(n){
    loop(n){yield;}
}